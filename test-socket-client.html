<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MeetHere Socket.io í…ŒìŠ¤íŠ¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .header {
      background: #667eea;
      color: white;
      padding: 20px;
      text-align: center;
    }

    .status {
      padding: 15px;
      text-align: center;
      font-weight: bold;
    }

    .status.connected {
      background: #10b981;
      color: white;
    }

    .status.disconnected {
      background: #ef4444;
      color: white;
    }

    .content {
      padding: 20px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f3f4f6;
      border-radius: 8px;
    }

    .section h2 {
      margin-bottom: 15px;
      color: #1f2937;
      font-size: 18px;
    }

    .input-group {
      margin-bottom: 10px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #4b5563;
      font-size: 14px;
      font-weight: 500;
    }

    input {
      width: 100%;
      padding: 10px;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
    }

    button:hover {
      background: #5568d3;
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .logs {
      background: #1f2937;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .log-entry {
      margin-bottom: 5px;
    }

    .log-time {
      color: #6b7280;
    }

    .log-event {
      color: #fbbf24;
      font-weight: bold;
    }

    .log-data {
      color: #10b981;
    }

    .participants {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .participant {
      background: #dbeafe;
      color: #1e40af;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    .locations {
      margin-top: 10px;
    }

    .location-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 4px solid #667eea;
    }

    .location-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .location-address {
      color: #6b7280;
      font-size: 13px;
    }

    .center-point {
      background: #fef3c7;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ MeetHere Socket.io í…ŒìŠ¤íŠ¸</h1>
      <p style="margin-top: 10px; opacity: 0.9;">ì‹¤ì‹œê°„ ë¯¸íŒ… & ìœ„ì¹˜ ê³µìœ  í”„ë¡œí† íƒ€ì…</p>
    </div>

    <div id="status" class="status disconnected">
      ğŸ”´ ì—°ê²° ëŠê¹€
    </div>

    <div class="content">
      <!-- ë¯¸íŒ… ì°¸ê°€ -->
      <div class="section">
        <h2>1ï¸âƒ£ ë¯¸íŒ… ì°¸ê°€</h2>

        <!-- ë¹ ë¥¸ ë¯¸íŒ… ì½”ë“œ ì„ íƒ -->
        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
          <button onclick="setMeetingCode('TEST01')" style="flex: 1; background: #6366f1; font-size: 13px;">ğŸ¯ TEST01</button>
          <button onclick="setMeetingCode('DEMO01')" style="flex: 1; background: #8b5cf6; font-size: 13px;">ğŸ¯ DEMO01</button>
          <button onclick="setMeetingCode('MEET01')" style="flex: 1; background: #ec4899; font-size: 13px;">ğŸ¯ MEET01</button>
        </div>

        <div class="input-group">
          <label>ë¯¸íŒ… ì½”ë“œ (6ìë¦¬)</label>
          <input type="text" id="meetingCode" placeholder="ì˜ˆ: ABC123" maxlength="6" value="TEST01">
        </div>
        <div class="input-group">
          <label>ì‚¬ìš©ì ID</label>
          <input type="text" id="userId" placeholder="ì˜ˆ: user123" value="">
        </div>
        <div class="input-group">
          <label>ì´ë¦„</label>
          <input type="text" id="userName" placeholder="ì˜ˆ: í™ê¸¸ë™" value="">
        </div>
        <button onclick="joinMeeting()" id="joinBtn">ë¯¸íŒ… ì°¸ê°€í•˜ê¸°</button>
      </div>

      <!-- ìœ„ì¹˜ ì¶”ê°€ -->
      <div class="section">
        <h2>2ï¸âƒ£ ìœ„ì¹˜ ì¶”ê°€</h2>

        <!-- ë¹ ë¥¸ ìƒ˜í”Œ ì¶”ê°€ ë²„íŠ¼ -->
        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button onclick="useSample('gangnam')" style="flex: 1; min-width: 120px; background: #10b981;">ğŸ“ ê°•ë‚¨ì—­</button>
          <button onclick="useSample('sinchon')" style="flex: 1; min-width: 120px; background: #3b82f6;">ğŸ“ ì‹ ì´Œì—­</button>
          <button onclick="useSample('hongdae')" style="flex: 1; min-width: 120px; background: #8b5cf6;">ğŸ“ í™ëŒ€ì…êµ¬ì—­</button>
          <button onclick="useSample('jamsil')" style="flex: 1; min-width: 120px; background: #f59e0b;">ğŸ“ ì ì‹¤ì—­</button>
        </div>

        <div class="input-group">
          <label>ì¥ì†Œ ì´ë¦„</label>
          <input type="text" id="locationName" placeholder="ì˜ˆ: ê°•ë‚¨ì—­" value="ê°•ë‚¨ì—­">
        </div>
        <div class="input-group">
          <label>ì£¼ì†Œ</label>
          <input type="text" id="locationAddress" placeholder="ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬" value="ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ê°•ë‚¨ëŒ€ë¡œ 396">
        </div>
        <div class="input-group">
          <label>ìœ„ë„ (Latitude)</label>
          <input type="number" step="0.000001" id="locationLat" placeholder="ì˜ˆ: 37.4979" value="37.497952">
        </div>
        <div class="input-group">
          <label>ê²½ë„ (Longitude)</label>
          <input type="number" step="0.000001" id="locationLng" placeholder="ì˜ˆ: 127.0276" value="127.027619">
        </div>
        <button onclick="addLocation()" id="addLocationBtn" disabled>ìœ„ì¹˜ ì¶”ê°€í•˜ê¸°</button>

        <!-- ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px dashed #d1d5db;">
          <div style="margin-bottom: 10px; font-weight: 600; color: #1f2937;">âš¡ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸</div>
          <div style="display: flex; gap: 10px;">
            <button onclick="addAllSamples()" style="flex: 1; background: #ef4444;" id="addAllBtn" disabled>
              ğŸš€ 4ê°œ ìœ„ì¹˜ í•œë²ˆì— ì¶”ê°€
            </button>
            <button onclick="clearLocations()" style="flex: 1; background: #6b7280;">
              ğŸ—‘ï¸ ì´ˆê¸°í™”
            </button>
          </div>
          <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
            ğŸ’¡ íŒ: ì‹¤ì‹œê°„ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë¸Œë¼ìš°ì € ì°½ì„ 2ê°œ ì—´ì–´ë³´ì„¸ìš”!
          </div>
        </div>
      </div>

      <!-- í˜„ì¬ ìƒíƒœ -->
      <div class="section">
        <h2>3ï¸âƒ£ í˜„ì¬ ë¯¸íŒ… ìƒíƒœ</h2>
        <div>
          <strong>ì°¸ê°€ì:</strong>
          <div class="participants" id="participants">
            <span style="color: #9ca3af;">ì•„ì§ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</span>
          </div>
        </div>
        <div style="margin-top: 20px;">
          <strong>ìœ„ì¹˜ ëª©ë¡:</strong>
          <div class="locations" id="locations">
            <span style="color: #9ca3af;">ì•„ì§ ìœ„ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤</span>
          </div>
        </div>
        <div id="centerPointDiv" style="display: none;">
          <strong>ì¤‘ê°„ì§€ì :</strong>
          <div class="center-point" id="centerPoint"></div>
        </div>
      </div>

      <!-- ì´ë²¤íŠ¸ ë¡œê·¸ -->
      <div class="section">
        <h2>4ï¸âƒ£ ì´ë²¤íŠ¸ ë¡œê·¸</h2>
        <div class="logs" id="logs">
          <div class="log-entry">
            <span class="log-time">[ëŒ€ê¸°ì¤‘]</span>
            <span class="log-data">ì„œë²„ ì—°ê²° ëŒ€ê¸° ì¤‘...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <script>
    let socket = null;
    let currentMeetingCode = null;

    // ìƒ˜í”Œ ìœ„ì¹˜ ë°ì´í„°
    const sampleLocations = {
      gangnam: {
        name: 'ê°•ë‚¨ì—­',
        address: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ê°•ë‚¨ëŒ€ë¡œ 396',
        lat: 37.497952,
        lng: 127.027619
      },
      sinchon: {
        name: 'ì‹ ì´Œì—­',
        address: 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œëŒ€ë¬¸êµ¬ ì‹ ì´Œì—­ë¡œ 90',
        lat: 37.555946,
        lng: 126.936893
      },
      hongdae: {
        name: 'í™ëŒ€ì…êµ¬ì—­',
        address: 'ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 160',
        lat: 37.557192,
        lng: 126.925381
      },
      jamsil: {
        name: 'ì ì‹¤ì—­',
        address: 'ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ ì§€í•˜ 265',
        lat: 37.513294,
        lng: 127.100388
      }
    };

    // ë¯¸íŒ… ì½”ë“œ ì„¤ì •
    function setMeetingCode(code) {
      document.getElementById('meetingCode').value = code;
      log('INFO', `ë¯¸íŒ… ì½”ë“œ ${code} ì„ íƒë¨`);
    }

    // ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
    function useSample(key) {
      const sample = sampleLocations[key];
      if (!sample) return;

      document.getElementById('locationName').value = sample.name;
      document.getElementById('locationAddress').value = sample.address;
      document.getElementById('locationLat').value = sample.lat;
      document.getElementById('locationLng').value = sample.lng;

      log('SAMPLE', `${sample.name} ìƒ˜í”Œ ë°ì´í„° ë¡œë“œë¨`);
    }

    // ëª¨ë“  ìƒ˜í”Œ ìœ„ì¹˜ í•œë²ˆì— ì¶”ê°€
    async function addAllSamples() {
      if (!currentMeetingCode) {
        alert('ë¨¼ì € ë¯¸íŒ…ì— ì°¸ê°€í•´ì£¼ì„¸ìš”!');
        return;
      }

      const confirmAdd = confirm('ê°•ë‚¨ì—­, ì‹ ì´Œì—­, í™ëŒ€ì…êµ¬ì—­, ì ì‹¤ì—­ 4ê°œ ìœ„ì¹˜ë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
      if (!confirmAdd) return;

      log('INFO', 'ğŸš€ 4ê°œ ìƒ˜í”Œ ìœ„ì¹˜ ì¼ê´„ ì¶”ê°€ ì‹œì‘...');

      // ìˆœì°¨ì ìœ¼ë¡œ ì¶”ê°€ (0.5ì´ˆ ê°„ê²©)
      for (const [key, sample] of Object.entries(sampleLocations)) {
        socket.emit('location:add', {
          meetingCode: currentMeetingCode,
          location: {
            name: sample.name,
            address: sample.address,
            lat: sample.lat,
            lng: sample.lng
          }
        });
        log('REQUEST', `${sample.name} ì¶”ê°€ë¨`);
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      log('SUCCESS', 'âœ… ëª¨ë“  ìƒ˜í”Œ ìœ„ì¹˜ ì¶”ê°€ ì™„ë£Œ!');
    }

    // ì´ˆê¸°í™”
    function clearLocations() {
      if (confirm('í˜„ì¬ ë¯¸íŒ… ë°ì´í„°ëŠ” ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) {
        window.location.reload();
      }
    }

    // ëœë¤ ì‚¬ìš©ì ID ìƒì„±
    const randomUserId = 'user_' + Math.random().toString(36).substr(2, 9);
    document.getElementById('userId').value = randomUserId;
    document.getElementById('userName').value = 'ì‚¬ìš©ì' + Math.floor(Math.random() * 100);

    // Socket.io ì—°ê²°
    function connectSocket() {
      socket = io('http://localhost:8090/meetings', {
        path: '/socket.io/',
        // í´ë§ìœ¼ë¡œ ì‹œì‘ í›„ WebSocket ì—…ê·¸ë ˆì´ë“œ (ê¸°ë³¸ ë™ì‘)
        transports: ['polling', 'websocket'],
        reconnection: true,
        withCredentials: true,
        timeout: 15000
      });

      socket.on('connect', () => {
        log('CONNECTED', `Socket ID: ${socket.id}`);
        updateStatus(true);
      });

      socket.on('disconnect', (reason) => {
        log('DISCONNECTED', `Reason: ${reason}`);
        updateStatus(false);
        document.getElementById('addLocationBtn').disabled = true;
      });

      socket.io.on('reconnect_attempt', (n) => {
        log('INFO', `Reconnecting... attempt #${n}`);
      });

      socket.io.on('reconnect_error', (err) => {
        log('ERROR', `Reconnect error: ${err?.message || err}`, true);
      });

      socket.io.on('reconnect_failed', () => {
        log('ERROR', 'Reconnect failed', true);
      });

      socket.on('connect_error', (err) => {
        log('ERROR', `Connect error: ${err?.message || err}`, true);
      });

      socket.on('meeting:state', (data) => {
        log('MEETING_STATE', JSON.stringify(data, null, 2));
        renderMeetingState(data);
      });

      socket.on('meeting:joined', (data) => {
        log('PARTICIPANT_JOINED', `${data.name} (${data.userId}) joined`);
      });

      socket.on('meeting:left', (data) => {
        log('PARTICIPANT_LEFT', `${data.name} (${data.userId}) left`);
      });

      socket.on('location:added', (data) => {
        log('LOCATION_ADDED', JSON.stringify(data, null, 2));
        // ìë™ìœ¼ë¡œ ìƒíƒœ ìš”ì²­ (ì„ì‹œ - ì‹¤ì œëŠ” ì„œë²„ê°€ state ë³´ë‚´ì¤Œ)
      });

      socket.on('error', (data) => {
        log('ERROR', `${data.code}: ${data.message}`, true);
        alert(`ì˜¤ë¥˜: ${data.message}`);
      });
    }

    // ë¯¸íŒ… ì°¸ê°€
    function joinMeeting() {
      const meetingCode = document.getElementById('meetingCode').value.toUpperCase();
      const userId = document.getElementById('userId').value;
      const userName = document.getElementById('userName').value;

      if (!meetingCode || meetingCode.length !== 6) {
        alert('ë¯¸íŒ… ì½”ë“œëŠ” 6ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤!');
        return;
      }

      if (!userId || !userName) {
        alert('ì‚¬ìš©ì IDì™€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }

      currentMeetingCode = meetingCode;
      socket.emit('meeting:join', {
        meetingCode,
        userId,
        name: userName,
      });

      document.getElementById('addLocationBtn').disabled = false;
      document.getElementById('addAllBtn').disabled = false;
      log('REQUEST', `ë¯¸íŒ… ì°¸ê°€ ìš”ì²­: ${meetingCode}`);
    }

    // ìœ„ì¹˜ ì¶”ê°€
    function addLocation() {
      if (!currentMeetingCode) {
        alert('ë¨¼ì € ë¯¸íŒ…ì— ì°¸ê°€í•´ì£¼ì„¸ìš”!');
        return;
      }

      const name = document.getElementById('locationName').value;
      const address = document.getElementById('locationAddress').value;
      const lat = parseFloat(document.getElementById('locationLat').value);
      const lng = parseFloat(document.getElementById('locationLng').value);

      if (!name || !address || isNaN(lat) || isNaN(lng)) {
        alert('ëª¨ë“  ìœ„ì¹˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }

      socket.emit('location:add', {
        meetingCode: currentMeetingCode,
        location: { name, address, lat, lng },
      });

      log('REQUEST', `ìœ„ì¹˜ ì¶”ê°€ ìš”ì²­: ${name}`);

      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById('locationName').value = '';
      document.getElementById('locationAddress').value = '';
    }

    // ë¯¸íŒ… ìƒíƒœ ë Œë”ë§
    function renderMeetingState(state) {
      // ì°¸ê°€ì ë Œë”ë§
      const participantsDiv = document.getElementById('participants');
      if (state.participants && state.participants.length > 0) {
        participantsDiv.innerHTML = state.participants
          .map(p => `<div class="participant">${p.name} (${p.userId})</div>`)
          .join('');
      }

      // ìœ„ì¹˜ ë Œë”ë§
      const locationsDiv = document.getElementById('locations');
      if (state.locations && state.locations.length > 0) {
        locationsDiv.innerHTML = state.locations
          .map(loc => `
            <div class="location-item">
              <div class="location-name">ğŸ“ ${loc.name}</div>
              <div class="location-address">${loc.address}</div>
              <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">
                ìœ„ë„: ${loc.lat}, ê²½ë„: ${loc.lng}
              </div>
            </div>
          `)
          .join('');
      }

      // ì¤‘ê°„ì§€ì  ë Œë”ë§
      if (state.centerPoint) {
        document.getElementById('centerPointDiv').style.display = 'block';
        document.getElementById('centerPoint').innerHTML = `
          ğŸ¯ ìœ„ë„: ${state.centerPoint.lat}, ê²½ë„: ${state.centerPoint.lng}
        `;
      }
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus(connected) {
      const statusDiv = document.getElementById('status');
      if (connected) {
        statusDiv.className = 'status connected';
        statusDiv.innerHTML = 'ğŸŸ¢ ì„œë²„ ì—°ê²°ë¨';
      } else {
        statusDiv.className = 'status disconnected';
        statusDiv.innerHTML = 'ğŸ”´ ì—°ê²° ëŠê¹€';
      }
    }

    // ë¡œê·¸ ì¶”ê°€
    function log(event, data, isError = false) {
      const logsDiv = document.getElementById('logs');
      const time = new Date().toLocaleTimeString('ko-KR');
      const entry = document.createElement('div');
      entry.className = 'log-entry';

      // ì´ë²¤íŠ¸ íƒ€ì…ë³„ ìƒ‰ìƒ
      let eventColor = '#fbbf24'; // ê¸°ë³¸ ë…¸ë€ìƒ‰
      let dataColor = '#10b981';  // ê¸°ë³¸ ì´ˆë¡ìƒ‰

      if (isError) {
        dataColor = '#ef4444'; // ë¹¨ê°„ìƒ‰
      } else if (event === 'CONNECTED') {
        eventColor = '#10b981';
        dataColor = '#10b981';
      } else if (event === 'SUCCESS') {
        eventColor = '#10b981';
        dataColor = '#10b981';
      } else if (event === 'INFO') {
        eventColor = '#3b82f6';
        dataColor = '#3b82f6';
      } else if (event === 'SAMPLE') {
        eventColor = '#8b5cf6';
        dataColor = '#8b5cf6';
      }

      entry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-event" style="color: ${eventColor};">${event}</span>
        <span class="log-data" style="color: ${dataColor};">${data}</span>
      `;
      logsDiv.appendChild(entry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²°
    window.onload = () => {
      connectSocket();
    };
  </script>
</body>
</html>
